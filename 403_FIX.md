# 403 Forbidden Error Fix

## Issue
After successful login, the dashboard was showing `403 Forbidden` errors when trying to fetch orders:
```
GET http://localhost:3000/api/orders?tenantId=demo-tenant 403 (Forbidden)
```

## Root Causes

### 1. RolesGuard Not Allowing SUPER_ADMIN
The `RolesGuard` only checked if the user's role matched the required roles (TENANT_ADMIN, KITCHEN, WAITER), but didn't give special access to SUPER_ADMIN users.

**File**: `apps/api/src/common/guards/roles.guard.ts`

**Fix**: Added check for SUPER_ADMIN role before checking required roles:
```typescript
// Super admins have access to everything
if (user.role === 'SUPER_ADMIN') {
  return true;
}
```

### 2. TenantMiddleware Not Handling Query Parameter Subdomain
The admin app was passing `tenantId=demo-tenant` as a query parameter, where `demo-tenant` is the subdomain, not the actual tenant UUID.

**File**: `apps/api/src/common/middleware/tenant.middleware.ts`

**Fix**: Enhanced middleware to:
1. Check query parameter first
2. Detect if it's a UUID or subdomain
3. If subdomain, lookup the actual tenant ID from database
4. Set the UUID as `request.tenantId`

```typescript
const queryTenantParam = req.query.tenantId as string;
if (queryTenantParam) {
  // Check if it's a UUID or subdomain
  if (queryTenantParam.includes('-') && queryTenantParam.length > 30) {
    tenantId = queryTenantParam;
  } else {
    // Treat as subdomain, look up the actual tenant ID
    const tenant = await this.prisma.tenant.findUnique({
      where: { subdomain: queryTenantParam },
      select: { id: true, status: true },
    });
    if (tenant && tenant.status === 'ACTIVE') {
      tenantId = tenant.id;
    }
  }
}
```

## Files Modified

1. ✅ `apps/api/src/common/guards/roles.guard.ts` - Added SUPER_ADMIN bypass
2. ✅ `apps/api/src/common/middleware/tenant.middleware.ts` - Added subdomain resolution

## Testing Required

### 1. Restart API Server
The API needs to be restarted to pick up the changes:
```bash
# Stop current API server (Ctrl+C)
# Then restart:
cd apps/api
npx ts-node --files src/main.ts
```

### 2. Test in Browser
1. Login with `admin@digitalorder.com` / `Admin@123`
2. Dashboard should load without 403 errors
3. Orders, menu, and analytics should all be accessible

### 3. Verify with cURL
```bash
# Login first to get token
TOKEN=$(curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"identifier": "admin@digitalorder.com", "password": "Admin@123"}' \
  | jq -r '.accessToken')

# Test orders endpoint
curl http://localhost:3000/api/orders?tenantId=demo-tenant \
  -H "Authorization: Bearer $TOKEN" \
  | jq
```

Should return orders array (empty or with data) instead of 403 error.

## Expected Behavior After Fix

1. ✅ SUPER_ADMIN can access all tenant-specific endpoints
2. ✅ Query parameter `tenantId=demo-tenant` resolves to actual tenant UUID
3. ✅ Dashboard loads orders successfully
4. ✅ Menu and analytics pages work
5. ✅ WebSocket connection established

## Technical Details

### Permission Hierarchy
```
SUPER_ADMIN > TENANT_ADMIN > KITCHEN/WAITER > CUSTOMER
```

- SUPER_ADMIN: Full access to all tenants and all endpoints
- TENANT_ADMIN: Admin access within their tenant
- KITCHEN/WAITER: Staff access within their tenant
- CUSTOMER: Limited access to their own data

### Tenant Resolution Order
1. Query parameter (`?tenantId=xxx`)
2. Custom header (`X-Tenant-Id`)
3. Subdomain (e.g., `demo.yourdomain.com`)
4. Custom domain (e.g., `restaurant.com`)

---

**Status**: ✅ Code Fixed - Restart Required  
**Date**: February 8, 2026
