# Render Blueprint - Free Tier Demo Deployment
# Deploy: Connect repo at render.com → New → Blueprint → Connect this file

services:
  # NestJS API Backend
  - type: web
    name: digital-order
    runtime: node

    # Build from monorepo root
    # Use --include=dev so @nestjs/cli is installed (Render skips devDeps when NODE_ENV=production)
    buildCommand: |
      npm install --include=dev
      npm run build --workspace=@digital-order/types
      npm run build --workspace=@digital-order/utils
      npm run build --workspace=@digital-order/config
      cd apps/api && npx prisma generate && npm run build

    startCommand: |
      cd apps/api && npx prisma migrate deploy && (npx prisma db execute --file prisma/ensure-menu-item-suggested-item.sql 2>/dev/null || true) && node dist/apps/api/src/main.js

    # Render free tier - spins down after 15 min inactivity
    plan: free

    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      # Set these in Render Dashboard → Environment:
      # - DATABASE_URL (from Supabase - pooler URL)
      # - DIRECT_URL (from Supabase - direct URL for migrations)
      # - REDIS_URL (from Upstash)
      # - JWT_SECRET
      # - JWT_REFRESH_SECRET
      # - CORS_ORIGIN
      # - FRONTEND_URL
      # - ADMIN_URL
      # - API_URL
